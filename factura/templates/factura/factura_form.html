{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Crear Factura{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="card p-4">
        <h2 class="card-title text-center mb-4">Crear Nueva Factura</h2>
        <form method="post" id="factura-form">
            {% csrf_token %}
            {{ form|crispy }}

            <hr class="my-4">

            <h3>Productos</h3>
            <div id="productos-container">
                <div class="row gx-2 mb-2 product-row">
                    <div class="col-8">
                        <select name="producto" class="form-control">
                            <option value="">-- Seleccionar Producto --</option>
                            {% for producto in productos %}
                                <option value="{{ producto.pk }}" data-precio="{{ producto.precio }}">{{ producto.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-3">
                        <input type="number" name="cantidad" placeholder="Cantidad" class="form-control">
                    </div>
                    <div class="col-1 d-flex align-items-end">
                        <button type="button" class="btn btn-danger btn-sm remove-product-btn">-</button>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <button type="button" class="btn btn-info btn-sm" id="add-product-btn">AÃ±adir Otro Producto</button>
            </div>

            <hr class="my-4">
            
            <div class="text-center mt-3">
                <button type="submit" class="btn btn-success me-2">Generar Factura</button>
                <a href="{% url 'productos:lista_productos' %}" class="btn btn-secondary">Cancelar</a> </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addProductBtn = document.getElementById('add-product-btn');
        const productosContainer = document.getElementById('productos-container');

        addProductBtn.addEventListener('click', function() {
            const lastProductRow = productosContainer.querySelector('.product-row:last-child');
            const newProductRow = lastProductRow.cloneNode(true);
            newProductRow.querySelector('select').value = '';
            newProductRow.querySelector('input').value = '';
            productosContainer.appendChild(newProductRow);
        });

        productosContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-product-btn')) {
                if (productosContainer.childElementCount > 1) {
                    e.target.closest('.product-row').remove();
                } else {
                    alert('Debe haber al menos un producto en la factura.');
                }
            }
        });
    });
</script>
{% endblock %}